{% comment %}
  Serializes data for the Screenlux Configurator V2.
  Fetches products from collections defined in conventions:
  - "Main product" (ZIP-Screen price variants)
  - "Installation brackets"
  - "Installation services"
  - "Add-ons"
{% endcomment %}

<script>
  window.ScreenluxData = {
    // 1. ZIP-Screen Variants (The Price Carriers)
    // We assume the collection 'Main product' contains the ZIP-Screen product(s).
    // We grab the first product found and list its variants.
    screens: [
      {%- assign main_coll = collections['main-product'] -%}
      {%- if main_coll.products.size > 0 -%}
        {%- assign carrier_product = main_coll.products.first -%}
        {%- for variant in carrier_product.variants -%}
          {
            id: {{ variant.id }},
            title: {{ variant.title | json }},
            sku: {{ variant.sku | json }},
            price: {{ variant.price }}, // Real sale price
            compare_at_price: {{ variant.compare_at_price | default: variant.price }}, // Used for strikethrough
            price_float: {{ variant.price | divided_by: 100.0 }}
          }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      {%- endif -%}
    ],

    // 2. Installation Brackets (DIY)
    brackets: [
      {%- assign bracket_coll = collections['installation-brackets'] -%}
      {%- assign sorted_brackets = bracket_coll.products | sort: 'price' -%}
      {%- for prod in sorted_brackets -%}
        {
           id: {{ prod.selected_or_first_available_variant.id }},
           title: {{ prod.title | json }},
           description: {{ prod.description | strip_html | truncate: 100 | json }},
           image: {{ prod.featured_image | image_url: width: 200 | json }},
           price: {{ prod.price }}
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ],

    // 3. Installation Services (Professional)
    // Expecting 1 product with "Wired" and "Solar" variants
    services: [
      {%- assign service_coll = collections['installation-services'] -%}
      {%- if service_coll.products.size > 0 -%}
        {%- assign service_prod = service_coll.products.first -%}
        {%- for variant in service_prod.variants -%}
        {
          id: {{ variant.id }},
          title: {{ variant.title | json }}, // Expected: "Wired" or "Solar"
          price: {{ variant.price }}
        }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      {%- endif -%}
    ],

    // 4. Add-ons
    addons: [
      {%- assign addon_coll = collections['add-ons'] -%}
      {%- for prod in addon_coll.products -%}
        {
          id: {{ prod.selected_or_first_available_variant.id }},
          title: {{ prod.title | json }},
          description: {{ prod.description | strip_html | truncate: 100 | json }},
          image: {{ prod.featured_image | image_url: width: 200 | json }},
          price: {{ prod.price }}
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ],

    // 5. Hardcoded Design Options (For Visual Configurator)
    frameColors: [
      { id: 'anthracite', title: 'Anthracite', hex: '#373F47', ral: 'RAL 7016', selected: true },
      { id: 'white', title: 'White', hex: '#FFFFFF', ral: 'RAL 9016', selected: false }
    ],
    fabricColors: [
      { id: 'graphite', title: 'Graphite', image: {{ 'img_fabric_graphite.png' | asset_url | json }} },
      { id: 'gray-pepper', title: 'Gray pepper', image: {{ 'img_fabric_gray_pepper.png' | asset_url | json }} },
      { id: 'natural', title: 'Natural', image: {{ 'img_fabric_natural.png' | asset_url | json }} },
      { id: 'edelweiss', title: 'Edelweiß', image: {{ 'img_fabric_edelweiss.png' | asset_url | json }} }
    ],
    fabrics: [
      {
        id: '5-percent',
        title: '5% Openness',
        desc: 'Perfect for living rooms and open spaces.',
        image: {{ 'img_fabric_5_percent_transparency.png' | asset_url | json }}
      },
      {
        id: 'blackout',
        title: 'Blackout',
        desc: 'Common for bathrooms and bedrooms.',
        image: {{ 'img_fabric_blackout.png' | asset_url | json }}
      }
    ],
    cassetteSizes: [
      { id: 'slim', title: 'Slim (85×85mm)', desc: 'Our slim standard cassette. For screens up to 5m².', image: 'https://cdn.shopify.com/s/files/1/0975/4676/4636/files/cassette-slim.jpg?v=1768220919' },
      { id: 'large', title: 'Large (120×120mm)', desc: 'When the slim cassette no longer fits.', image: 'https://cdn.shopify.com/s/files/1/0975/4676/4636/files/cassette-large.jpg?v=1768220918' }
    ],
    motorOptions: [
      { id: 'solar', title: 'Solar-powered screen', desc: 'Hassle-free installation with solar panel.', image: {{ 'img-cassette-solar-panel.png' | asset_img_url: '400x' | json }}, surcharge: 10000 },
      { id: 'wired', title: 'Wired screen', desc: 'Traditional and safe.', image: {{ 'img-cassette-wired.png' | asset_img_url: '400x' | json }}, surcharge: 0 }
    ],

    assets: {
      german_badge: {{ 'img-gda26-winner-screenlux.png' | asset_url | json }},
      truck_icon: {{ 'icon-sl-truck.svg' | asset_url | json }},
      // Dynamic product images for all option combinations
      productImages: {
        'AC-AN-EWH-5OPEN': {{ 'img-variantSLX85-AC-AN-EWH-5OPEN.jpg' | asset_url | json }},
        'AC-AN-EWH-BLACKOUT': {{ 'img-variantSLX85-AC-AN-WH-EWH-BLACKOUT.jpg' | asset_url | json }},
        'AC-AN-GRP-5OPEN': {{ 'img-variantSLX85-AC-AN-GRP-5OPEN.jpg' | asset_url | json }},
        'AC-AN-GRP-BLACKOUT': {{ 'img-variantSLX85-AC-AN-WH-GRP-BLACKOUT.jpg' | asset_url | json }},
        'AC-AN-NAT-5OPEN': {{ 'img-variantSLX85-AC-AN-NAT-5OPEN.jpg' | asset_url | json }},
        'AC-AN-NAT-BLACKOUT': {{ 'img-variantSLX85-AC-AN-WH-NAT-BLACKOUT.jpg' | asset_url | json }},
        'AC-AN-PEP-5OPEN': {{ 'img-variantSLX85-AC-AN-PEP-5OPEN.jpg' | asset_url | json }},
        'AC-AN-PEP-BLACKOUT': {{ 'img-variantSLX85-AC-AN-WH-PEP-BLACKOUT.jpg' | asset_url | json }},
        'AC-WH-EWH-5OPEN': {{ 'img-variantSLX85-AC-WH-EWH-5OPEN.jpg' | asset_url | json }},
        'AC-WH-EWH-BLACKOUT': {{ 'img-variantSLX85-AC-WH-EWH-BLACKOUT.jpg' | asset_url | json }},
        'AC-WH-GRP-5OPEN': {{ 'img-variantSLX85-AC-WH-GRP-5OPEN.jpg' | asset_url | json }},
        'AC-WH-GRP-BLACKOUT': {{ 'img-variantSLX85-AC-WH-GRP-BLACKOUT.jpg' | asset_url | json }},
        'AC-WH-NAT-5OPEN': {{ 'img-variantSLX85-AC-WH-NAT-5OPEN.jpg' | asset_url | json }},
        'AC-WH-NAT-BLACKOUT': {{ 'img-variantSLX85-AC-WH-NAT-BLACKOUT.jpg' | asset_url | json }},
        'AC-WH-PEP-5OPEN': {{ 'img-variantSLX85-AC-WH-PEP-5OPEN.jpg' | asset_url | json }},
        'AC-WH-PEP-BLACKOUT': {{ 'img-variantSLX85-AC-WH-PEP-BLACKOUT.jpg' | asset_url | json }},
        'DC-AN-EWH-5OPEN': {{ 'img-variantSLX85-DC-AN-EWH-5OPEN.jpg' | asset_url | json }},
        'DC-AN-EWH-BLACKOUT': {{ 'img-variantSLX85-DC-AN-EWH-BLAC-AN-WHKOUT.jpg' | asset_url | json }},
        'DC-AN-GRP-5OPEN': {{ 'img-variantSLX85-DC-AN-GRP-5OPEN.jpg' | asset_url | json }},
        'DC-AN-GRP-BLACKOUT': {{ 'img-variantSLX85-DC-AN-GRP-BLAC-AN-WHKOUT.jpg' | asset_url | json }},
        'DC-AN-NAT-5OPEN': {{ 'img-variantSLX85-DC-AN-NAT-5OPEN.jpg' | asset_url | json }},
        'DC-AN-NAT-BLACKOUT': {{ 'img-variantSLX85-DC-AN-NAT-BLAC-AN-WHKOUT.jpg' | asset_url | json }},
        'DC-AN-PEP-5OPEN': {{ 'img-variantSLX85-DC-AN-PEP-5OPEN.jpg' | asset_url | json }},
        'DC-AN-PEP-BLACKOUT': {{ 'img-variantSLX85-DC-AN-PEP-BLAC-AN-WHKOUT.jpg' | asset_url | json }},
        'DC-WH-EWH-5OPEN': {{ 'img-variantSLX85-DC-WH-EWH-5OPEN.jpg' | asset_url | json }},
        'DC-WH-EWH-BLACKOUT': {{ 'img-variantSLX85-DC-WH-EWH-BLAC-WHKOUT.jpg' | asset_url | json }},
        'DC-WH-GRP-5OPEN': {{ 'img-variantSLX85-DC-WH-GRP-5OPEN.jpg' | asset_url | json }},
        'DC-WH-GRP-BLACKOUT': {{ 'img-variantSLX85-DC-WH-GRP-BLAC-WHKOUT.jpg' | asset_url | json }},
        'DC-WH-NAT-5OPEN': {{ 'img-variantSLX85-DC-WH-NAT-5OPEN.jpg' | asset_url | json }},
        'DC-WH-NAT-BLACKOUT': {{ 'img-variantSLX85-DC-WH-NAT-BLAC-WHKOUT.jpg' | asset_url | json }},
        'DC-WH-PEP-5OPEN': {{ 'img-variantSLX85-DC-WH-PEP-5OPEN.jpg' | asset_url | json }},
        'DC-WH-PEP-BLACKOUT': {{ 'img-variantSLX85-DC-WH-PEP-BLAC-WHKOUT.jpg' | asset_url | json }}
      }
    },
    // Configuration Constants
    // Configuration Constants (From Theme Settings)
    config: {
       base_price: {{ settings.configurator_base_price | default: 50000 }},
       price_per_sqm: {{ settings.configurator_price_per_sqm | default: 0 }},
       min_billable_sqm: {{ settings.configurator_min_billable | default: 0 }},
       base_includes_sqm: {{ settings.configurator_base_includes | default: 0 }},
       surcharge_solar: {{ settings.configurator_surcharge_solar | default: 10000 }},
       surcharge_cassette: {{ settings.configurator_surcharge_cassette | default: 5000 }}
    }
  };
</script>
