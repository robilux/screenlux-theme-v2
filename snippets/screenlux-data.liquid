{% comment %}
  Serializes data for the Screenlux Configurator V2.
  Fetches products from collections defined in conventions:
  - "Main product" (ZIP-Screen price variants)
  - "Installation brackets"
  - "Installation services"
  - "Add-ons"
{% endcomment %}

<script>
  window.ScreenluxTranslations = {
    title: {{ 'configurator.title' | t | json }},
    addAnotherOne: {{ 'configurator.add_another_one' | t | json }},
    installationTitle: {{ 'configurator.installation_title' | t | json }},
    tipTitle: {{ 'configurator.tip_title' | t | json }},
    tipMessageHtml: {{ 'configurator.tip_message_html' | t | json }},
    tipBenefits: {
      noWiring: {{ 'configurator.tip_benefits.no_wiring' | t | json }},
      noWallDrilling: {{ 'configurator.tip_benefits.no_wall_drilling' | t | json }},
      noElectrician: {{ 'configurator.tip_benefits.no_electrician' | t | json }}
    },
    tipFooterHtml: {{ 'configurator.tip_footer_html' | t | json }},
    switchToSolar: {{ 'configurator.switch_to_solar' | t | json }},
    installationDiy: {
      title: {{ 'configurator.installation_diy.title' | t | json }},
      desc: {{ 'configurator.installation_diy.desc' | t | json }},
      price: {{ 'configurator.installation_diy.price' | t | json }}
    },
    installationProfessional: {
      title: {{ 'configurator.installation_professional.title' | t | json }},
      desc: {{ 'configurator.installation_professional.desc' | t | json }},
      price: {{ 'configurator.installation_professional.price' | t | json }},
      note: {{ 'configurator.installation_professional.note' | t | json }}
    },
    addonsTitle: {{ 'configurator.addons_title' | t | json }},
    noAddons: {{ 'configurator.no_addons' | t | json }},
    add: {{ 'configurator.add' | t | json }},
    orderSummaryTitle: {{ 'configurator.order_summary_title' | t | json }},
    orderSummary: {
      zipScreens: {{ 'configurator.order_summary.zip_screens' | t | json }},
      addons: {{ 'configurator.order_summary.addons' | t | json }},
      professionalInstallation: {{ 'configurator.order_summary.professional_installation' | t | json }},
      total: {{ 'configurator.order_summary.total' | t | json }},
      freeDelivery: {{ 'configurator.order_summary.free_delivery' | t | json }},
      arrivesIn: {{ 'configurator.order_summary.arrives_in' | t | json }},
      continueToPayment: {{ 'configurator.order_summary.continue_to_payment' | t | json }},
      pleaseCheckDimensions: {{ 'configurator.order_summary.please_check_dimensions' | t | json }},
      zipScreenDetail: {{ 'configurator.order_summary.zip_screen_detail' | t | json }},
      perScreen: {{ 'configurator.order_summary.per_screen' | t | json }}
    },
    awards: {
      awardTitle: {{ 'configurator.awards.award_title' | t | json }},
      awardText: {{ 'configurator.awards.award_text' | t | json }}
    },
    dimensions: {
      width: {{ 'configurator.dimensions.width' | t | json }},
      height: {{ 'configurator.dimensions.height' | t | json }},
      invalid: {{ 'configurator.dimensions.invalid' | t | json }}
    },
    options: {
      cassetteSize: {{ 'configurator.options.cassette_size' | t | json }},
      frameColor: {{ 'configurator.options.frame_color' | t | json }},
      fabricColor: {{ 'configurator.options.fabric_color' | t | json }},
      fabricTransparency: {{ 'configurator.options.fabric_transparency' | t | json }},
      motor: {{ 'configurator.options.motor' | t | json }}
    },
    actions: {
      removeScreen: {{ 'configurator.actions.remove_screen' | t | json }},
      duplicateScreen: {{ 'configurator.actions.duplicate_screen' | t | json }},
      openScreen: {{ 'configurator.actions.open_screen' | t | json }},
      closeScreen: {{ 'configurator.actions.close_screen' | t | json }},
      showMeasurements: {{ 'configurator.actions.show_measurements' | t | json }},
      hideMeasurements: {{ 'configurator.actions.hide_measurements' | t | json }}
    },
    screenSummary: {
      prefix: {{ 'configurator.screen_summary.prefix' | t | json }},
      dimensionsNotSet: {{ 'configurator.screen_summary.dimensions_not_set' | t | json }},
      noCassette: {{ 'configurator.screen_summary.no_cassette' | t | json }},
      noFrame: {{ 'configurator.screen_summary.no_frame' | t | json }},
      noFabric: {{ 'configurator.screen_summary.no_fabric' | t | json }},
      noMotor: {{ 'configurator.screen_summary.no_motor' | t | json }}
    },
    misc: {
      loading: {{ 'configurator.misc.loading' | t | json }},
      loadingDesc: {{ 'configurator.misc.loading_desc' | t | json }},
      loadingDescSub: {{ 'configurator.misc.loading_desc_sub' | t | json }},
      developedInGermany: {{ 'configurator.misc.developed_in_germany' | t | json }}
    }
  };

  window.ScreenluxData = {
    // 1. ZIP-Screen Variants (The Price Carriers)
    // We assume the collection 'Main product' contains the ZIP-Screen product(s).
    // We grab the first product found and list its variants.
    screens: [
      {%- assign main_coll = collections['main-product'] -%}
      {%- if main_coll.products.size > 0 -%}
        {%- assign carrier_product = main_coll.products.first -%}
        {%- for variant in carrier_product.variants -%}
          {
            id: {{ variant.id }},
            title: {{ variant.title | json }},
            sku: {{ variant.sku | json }},
            price: {{ variant.price }}, // Real sale price
            compare_at_price: {{ variant.compare_at_price | default: variant.price }}, // Used for strikethrough
            price_float: {{ variant.price | divided_by: 100.0 }}
          }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      {%- endif -%}
    ],

    // 2. Installation Brackets (DIY)
    brackets: [
      {%- assign bracket_coll = collections['installation-brackets'] -%}
      {%- assign sorted_brackets = bracket_coll.products | sort: 'price' -%}
      {%- for prod in sorted_brackets -%}
        {
           id: {{ prod.selected_or_first_available_variant.id }},
           title: {{ prod.title | json }},
           description: {{ prod.description | strip_html | truncate: 100 | json }},
           {% if prod.featured_image %}
             image: {{ prod.featured_image | image_url: width: 200 | json }},
           {% else %}
             image: null,
           {% endif %}
           price: {{ prod.price }}
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ],

    // 3. Installation Services (Professional)
    // Expecting 1 product with "Wired" and "Solar" variants
    services: [
      {%- assign service_coll = collections['installation-services'] -%}
      {%- if service_coll.products.size > 0 -%}
        {%- assign service_prod = service_coll.products.first -%}
        {%- for variant in service_prod.variants -%}
        {
          id: {{ variant.id }},
          title: {{ variant.title | json }}, // Expected: "Wired" or "Solar"
          price: {{ variant.price }}
        }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      {%- endif -%}
    ],

    // 4. Add-ons
    addons: [
      {%- assign addon_coll = collections['add-ons'] -%}
      {%- for prod in addon_coll.products -%}
        {
          id: {{ prod.selected_or_first_available_variant.id }},
          title: {{ prod.title | json }},
          description: {{ prod.description | strip_html | truncate: 100 | json }},
          {% if prod.featured_image %}
            image: {{ prod.featured_image | image_url: width: 200 | json }},
          {% else %}
            image: null,
          {% endif %}
          price: {{ prod.price }},
          compare_at_price: {{ prod.compare_at_price | default: prod.price }}
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ],

    // 5. Hardcoded Design Options (For Visual Configurator)
    frameColors: [
      { id: 'anthracite', title: {{ 'configurator.data.frameColors.anthracite' | t | json }}, hex: '#373F47', ral: 'RAL 7016', selected: true },
      { id: 'white', title: {{ 'configurator.data.frameColors.white' | t | json }}, hex: '#FFFFFF', ral: 'RAL 9016', selected: false }
    ],
    fabricColors: [
      { id: 'graphite', title: {{ 'configurator.data.fabricColors.graphite' | t | json }}, image: {{ 'img_fabric_graphite.png' | asset_img_url: '400x' | json }} },
      { id: 'gray-pepper', title: {{ 'configurator.data.fabricColors.gray_pepper' | t | json }}, image: {{ 'img_fabric_gray_pepper.png' | asset_img_url: '400x' | json }} },
      { id: 'natural', title: {{ 'configurator.data.fabricColors.natural' | t | json }}, image: {{ 'img_fabric_natural.png' | asset_img_url: '400x' | json }} },
      { id: 'edelweiss', title: {{ 'configurator.data.fabricColors.edelweiss' | t | json }}, image: {{ 'img_fabric_edelweiss.png' | asset_img_url: '400x' | json }} }
    ],
    fabrics: [
      {
        id: '5-percent',
        title: {{ 'configurator.data.fabrics.per_5_openness.title' | t | json }},
        desc: {{ 'configurator.data.fabrics.per_5_openness.desc' | t | json }},
        image: {{ 'img_fabric_5_percent_transparency.png' | asset_url | json }}
      },
      {
        id: 'blackout',
        title: {{ 'configurator.data.fabrics.blackout.title' | t | json }},
        desc: {{ 'configurator.data.fabrics.blackout.desc' | t | json }},
        image: {{ 'img_fabric_blackout.png' | asset_url | json }}
      }
    ],
    cassetteSizes: [
      { id: 'slim', title: {{ 'configurator.data.cassetteSizes.slim.title' | t | json }}, desc: {{ 'configurator.data.cassetteSizes.slim.desc' | t | json }}, image: 'https://cdn.shopify.com/s/files/1/0975/4676/4636/files/cassette-slim.jpg?v=1768220919' },
      { id: 'large', title: {{ 'configurator.data.cassetteSizes.large.title' | t | json }}, desc: {{ 'configurator.data.cassetteSizes.large.desc' | t | json }}, image: 'https://cdn.shopify.com/s/files/1/0975/4676/4636/files/cassette-large.jpg?v=1768220918' }
    ],
    motorOptions: [
      { id: 'solar', title: {{ 'configurator.data.motorOptions.solar.title' | t | json }}, desc: {{ 'configurator.data.motorOptions.solar.desc' | t | json }}, image: {{ 'img-cassette-solar-panel.png' | asset_img_url: '400x' | json }}, surcharge: 10000 },
      { id: 'wired', title: {{ 'configurator.data.motorOptions.wired.title' | t | json }}, desc: {{ 'configurator.data.motorOptions.wired.desc' | t | json }}, image: {{ 'img-cassette-wired.png' | asset_img_url: '400x' | json }}, surcharge: 0 }
    ],

    assets: {
      german_badge: {{ 'img-gda26-winner-screenlux.png' | asset_url | json }},
      truck_icon: {{ 'icon-sl-truck.svg' | asset_url | json }},
      // Dynamic product images for all option combinations
      productImages: {
        'AC-AN-EWH-5OPEN': {{ 'img-variantSLX85-AC-AN-EWH-5OPEN.jpg' | asset_url | json }},
        'AC-AN-EWH-BLACKOUT': {{ 'img-variantSLX85-AC-AN-WH-EWH-BLACKOUT.jpg' | asset_url | json }},
        'AC-AN-GRP-5OPEN': {{ 'img-variantSLX85-AC-AN-GRP-5OPEN.jpg' | asset_url | json }},
        'AC-AN-GRP-BLACKOUT': {{ 'img-variantSLX85-AC-AN-WH-GRP-BLACKOUT.jpg' | asset_url | json }},
        'AC-AN-NAT-5OPEN': {{ 'img-variantSLX85-AC-AN-NAT-5OPEN.jpg' | asset_url | json }},
        'AC-AN-NAT-BLACKOUT': {{ 'img-variantSLX85-AC-AN-WH-NAT-BLACKOUT.jpg' | asset_url | json }},
        'AC-AN-PEP-5OPEN': {{ 'img-variantSLX85-AC-AN-PEP-5OPEN.jpg' | asset_url | json }},
        'AC-AN-PEP-BLACKOUT': {{ 'img-variantSLX85-AC-AN-WH-PEP-BLACKOUT.jpg' | asset_url | json }},
        'AC-WH-EWH-5OPEN': {{ 'img-variantSLX85-AC-WH-EWH-5OPEN.jpg' | asset_url | json }},
        'AC-WH-EWH-BLACKOUT': {{ 'img-variantSLX85-AC-WH-EWH-BLACKOUT.jpg' | asset_url | json }},
        'AC-WH-GRP-5OPEN': {{ 'img-variantSLX85-AC-WH-GRP-5OPEN.jpg' | asset_url | json }},
        'AC-WH-GRP-BLACKOUT': {{ 'img-variantSLX85-AC-WH-GRP-BLACKOUT.jpg' | asset_url | json }},
        'AC-WH-NAT-5OPEN': {{ 'img-variantSLX85-AC-WH-NAT-5OPEN.jpg' | asset_url | json }},
        'AC-WH-NAT-BLACKOUT': {{ 'img-variantSLX85-AC-WH-NAT-BLACKOUT.jpg' | asset_url | json }},
        'AC-WH-PEP-5OPEN': {{ 'img-variantSLX85-AC-WH-PEP-5OPEN.jpg' | asset_url | json }},
        'AC-WH-PEP-BLACKOUT': {{ 'img-variantSLX85-AC-WH-PEP-BLACKOUT.jpg' | asset_url | json }},
        'DC-AN-EWH-5OPEN': {{ 'img-variantSLX85-DC-AN-EWH-5OPEN.jpg' | asset_url | json }},
        'DC-AN-EWH-BLACKOUT': {{ 'img-variantSLX85-DC-AN-EWH-BLAC-AN-BLACKOUT.jpg' | asset_url | json }},
        'DC-AN-GRP-5OPEN': {{ 'img-variantSLX85-DC-AN-GRP-5OPEN.jpg' | asset_url | json }},
        'DC-AN-GRP-BLACKOUT': {{ 'img-variantSLX85-DC-AN-GRP-BLAC-AN-BLACKOUT.jpg' | asset_url | json }},
        'DC-AN-NAT-5OPEN': {{ 'img-variantSLX85-DC-AN-NAT-5OPEN.jpg' | asset_url | json }},
        'DC-AN-NAT-BLACKOUT': {{ 'img-variantSLX85-DC-AN-NAT-BLAC-AN-BLACKOUT.jpg' | asset_url | json }},
        'DC-AN-PEP-5OPEN': {{ 'img-variantSLX85-DC-AN-PEP-5OPEN.jpg' | asset_url | json }},
        'DC-AN-PEP-BLACKOUT': {{ 'img-variantSLX85-DC-AN-PEP-BLAC-AN-BLACKOUT.jpg' | asset_url | json }},
        'DC-WH-EWH-5OPEN': {{ 'img-variantSLX85-DC-WH-EWH-5OPEN.jpg' | asset_url | json }},
        'DC-WH-EWH-BLACKOUT': {{ 'img-variantSLX85-DC-WH-EWH-BLAC-BLACKOUT.jpg' | asset_url | json }},
        'DC-WH-GRP-5OPEN': {{ 'img-variantSLX85-DC-WH-GRP-5OPEN.jpg' | asset_url | json }},
        'DC-WH-GRP-BLACKOUT': {{ 'img-variantSLX85-DC-WH-GRP-BLAC-BLACKOUT.jpg' | asset_url | json }},
        'DC-WH-NAT-5OPEN': {{ 'img-variantSLX85-DC-WH-NAT-5OPEN.jpg' | asset_url | json }},
        'DC-WH-NAT-BLACKOUT': {{ 'img-variantSLX85-DC-WH-NAT-BLAC-BLACKOUT.jpg' | asset_url | json }},
        'DC-WH-PEP-5OPEN': {{ 'img-variantSLX85-DC-WH-PEP-5OPEN.jpg' | asset_url | json }},
        'DC-WH-PEP-BLACKOUT': {{ 'img-variantSLX85-DC-WH-PEP-BLAC-BLACKOUT.jpg' | asset_url | json }}
      }
    },
    // Configuration Constants
    // Configuration Constants (From Theme Settings)
    config: {
       base_price: {{ settings.configurator_base_price | default: 50000 }},
       price_per_sqm: {{ settings.configurator_price_per_sqm | default: 0 }},
       min_billable_sqm: {{ settings.configurator_min_billable | default: 0 }},
       base_includes_sqm: {{ settings.configurator_base_includes | default: 0 }},
       surcharge_solar: {{ settings.configurator_surcharge_solar | default: 10000 }},
       surcharge_cassette: {{ settings.configurator_surcharge_cassette | default: 5000 }}
    }
  };
</script>
