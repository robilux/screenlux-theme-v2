{% comment %}
  Serializes data for the Screenlux Configurator V2.
  Fetches products from collections defined in conventions:
  - "Main product" (ZIP-Screen price variants)
  - "Installation brackets"
  - "Installation services"
  - "Add-ons"
{% endcomment %}

<script>
  window.ScreenluxData = {
    // 1. ZIP-Screen Variants (The Price Carriers)
    // We assume the collection 'Main product' contains the ZIP-Screen product(s).
    // We grab the first product found and list its variants.
    screens: [
      {%- assign main_coll = collections['main-product'] -%}
      {%- if main_coll.products.size > 0 -%}
        {%- assign carrier_product = main_coll.products.first -%}
        {%- for variant in carrier_product.variants -%}
          {
            id: {{ variant.id }},
            title: {{ variant.title | json }},
            price: {{ variant.price }}, // Raw cents
            price_float: {{ variant.price | divided_by: 100.0 }}
          }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      {%- endif -%}
    ],

    // 2. Installation Brackets (DIY)
    brackets: [
      {%- assign bracket_coll = collections['installation-brackets'] -%}
      {%- assign sorted_brackets = bracket_coll.products | sort: 'price' -%}
      {%- for prod in sorted_brackets -%}
        {
           id: {{ prod.selected_or_first_available_variant.id }},
           title: {{ prod.title | json }},
           description: {{ prod.description | strip_html | truncate: 100 | json }},
           image: {{ prod.featured_image | image_url: width: 200 | json }},
           price: {{ prod.price }}
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ],

    // 3. Installation Services (Professional)
    // Expecting 1 product with "Wired" and "Solar" variants
    services: [
      {%- assign service_coll = collections['installation-services'] -%}
      {%- if service_coll.products.size > 0 -%}
        {%- assign service_prod = service_coll.products.first -%}
        {%- for variant in service_prod.variants -%}
        {
          id: {{ variant.id }},
          title: {{ variant.title | json }}, // Expected: "Wired" or "Solar"
          price: {{ variant.price }}
        }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      {%- endif -%}
    ],

    // 4. Add-ons
    addons: [
      {%- assign addon_coll = collections['add-ons'] -%}
      {%- for prod in addon_coll.products -%}
        {
          id: {{ prod.selected_or_first_available_variant.id }},
          title: {{ prod.title | json }},
          description: {{ prod.description | strip_html | truncate: 100 | json }},
          image: {{ prod.featured_image | image_url: width: 200 | json }},
          price: {{ prod.price }}
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ],

    // 5. Hardcoded Design Options (For Visual Configurator)
    frameColors: [
      { id: 'anthracite', title: 'Anthracite', hex: '#373F47', ral: 'RAL 7016', selected: true },
      { id: 'white', title: 'White', hex: '#FFFFFF', ral: 'RAL 9016', selected: false }
    ],
    fabricColors: [
      { id: 'charcoal', title: 'Charcoal', desc: 'Popular!', hex: '#1F1F1F' },
      { id: 'gray', title: 'Gray', desc: 'Calm and traditional', hex: '#6B7280' }
    ],
    fabrics: [
      {
        id: '4-percent',
        title: '4% Openness',
        desc: 'Perfect for living rooms and open spaces.',
        image: 'https://cdn.shopify.com/s/files/1/0975/4676/4636/files/fabric-4-percent.jpg?v=1768220972'
      },
      {
        id: 'blackout',
        title: 'Blackout',
        desc: 'Common for bathrooms and bedrooms.',
        image: 'https://cdn.shopify.com/s/files/1/0975/4676/4636/files/fabric-blackout.jpg?v=1768220971'
      }
    ],
    cassetteSizes: [
      { id: 'slim', title: 'Slim (85×85mm)', desc: 'Our slim standard cassette. For screens up to 5m².', image: 'https://cdn.shopify.com/s/files/1/0975/4676/4636/files/cassette-slim.jpg?v=1768220919' },
      { id: 'large', title: 'Large (120×120mm)', desc: 'When the slim cassette no longer fits.', image: 'https://cdn.shopify.com/s/files/1/0975/4676/4636/files/cassette-large.jpg?v=1768220918' }
    ],
    motorOptions: [
      { id: 'solar', title: 'Solar-powered screen', desc: 'Hassle-free installation with solar panel.', image: 'https://cdn.shopify.com/s/files/1/0975/4676/4636/files/motor-solar.jpg?v=1768220938', surcharge: 10000 },
      { id: 'wired', title: 'Wired screen', desc: 'Traditional and safe.', image: 'https://cdn.shopify.com/s/files/1/0975/4676/4636/files/motor-wired.jpg?v=1768220938', surcharge: 0 }
    ],

    assets: {
      german_badge: {{ 'GDA26-winner-screenlux.png' | asset_url | json }},
      truck_icon: {{ 'Truck.svg' | asset_url | json }}
    },
    // Configuration Constants
    // Configuration Constants (From Theme Settings)
    config: {
       base_price: {{ settings.configurator_base_price | default: 50000 }},
       price_per_sqm: {{ settings.configurator_price_per_sqm | default: 0 }},
       min_billable_sqm: {{ settings.configurator_min_billable | default: 0 }},
       base_includes_sqm: {{ settings.configurator_base_includes | default: 0 }},
       surcharge_solar: {{ settings.configurator_surcharge_solar | default: 10000 }},
       surcharge_cassette: {{ settings.configurator_surcharge_cassette | default: 5000 }}
    }
  };
</script>
