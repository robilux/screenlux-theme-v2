{% comment %}
  Serializes data for the Screenlux Configurator V2.
  Fetches products from collections defined in conventions:
  - "Main product" (ZIP-Screen price variants)
  - "Installation brackets"
  - "Installation services"
  - "Add-ons"
{% endcomment %}

<script>
  window.ScreenluxData = {
    // 1. ZIP-Screen Variants (The Price Carriers)
    // We assume the collection 'Main product' contains the ZIP-Screen product(s).
    // We grab the first product found and list its variants.
    screens: [
      {%- assign main_coll = collections['main-product'] -%}
      {%- if main_coll.products.size > 0 -%}
        {%- assign carrier_product = main_coll.products.first -%}
        {%- for variant in carrier_product.variants -%}
          {
            id: {{ variant.id }},
            title: {{ variant.title | json }},
            price: {{ variant.price }}, // Raw cents
            price_float: {{ variant.price | divided_by: 100.0 }}
          }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      {%- endif -%}
    ],

    // 2. Installation Brackets (DIY)
    brackets: [
      {%- assign bracket_coll = collections['installation-brackets'] -%}
      {%- for prod in bracket_coll.products -%}
        {
           id: {{ prod.selected_or_first_available_variant.id }},
           title: {{ prod.title | json }},
           image: {{ prod.featured_image | image_url: width: 200 | json }},
           price: {{ prod.price }}
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ],

    // 3. Installation Services (Professional)
    // Expecting 1 product with "Wired" and "Solar" variants
    services: [
      {%- assign service_coll = collections['installation-services'] -%}
      {%- if service_coll.products.size > 0 -%}
        {%- assign service_prod = service_coll.products.first -%}
        {%- for variant in service_prod.variants -%}
        {
          id: {{ variant.id }},
          title: {{ variant.title | json }}, // Expected: "Wired" or "Solar"
          price: {{ variant.price }}
        }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      {%- endif -%}
    ],

    // 4. Add-ons
    addons: [
      {%- assign addon_coll = collections['add-ons'] -%}
      {%- for prod in addon_coll.products -%}
        {
          id: {{ prod.selected_or_first_available_variant.id }},
          title: {{ prod.title | json }},
          price: {{ prod.price }}
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ],

    // 5. Hardcoded Design Options (For Visual Configurator)
    frameColors: [
      { id: 'anthracite', title: 'Anthracite', hex: '#373F47', selected: true },
      { id: 'white', title: 'White', hex: '#FFFFFF', selected: false },
      { id: 'gray', title: 'Gray', hex: '#9CA3AF', selected: false },
      { id: 'black', title: 'Black', hex: '#111827', selected: false }
    ],
    fabrics: [
      {
        id: '5-percent',
        title: '5% Openness',
        desc: 'Perfect for living rooms.',
        image: 'https://cdn.shopify.com/s/files/1/0663/7708/9244/files/fabric_5.jpg',
        colors: ['Grey', 'Charcoal', 'White']
      },
      {
        id: '1-percent',
        title: '1% Openness',
        desc: 'Balanced privacy.',
        image: 'https://cdn.shopify.com/s/files/1/0663/7708/9244/files/fabric_1.jpg',
        colors: ['Grey', 'Charcoal', 'White']
      },
      {
        id: 'blackout',
        title: 'Blackout',
        desc: 'Complete darkness.',
        image: 'https://cdn.shopify.com/s/files/1/0663/7708/9244/files/fabric_blackout.jpg',
        colors: ['Grey', 'Charcoal']
      }
    ],

    // Configuration Constants
    // Configuration Constants (From Theme Settings)
    config: {
       base_price: {{ settings.configurator_base_price | default: 50000 }},
       price_per_sqm: {{ settings.configurator_price_per_sqm | default: 0 }},
       min_billable_sqm: {{ settings.configurator_min_billable | default: 0 }},
       base_includes_sqm: {{ settings.configurator_base_includes | default: 0 }},
       surcharge_solar: {{ settings.configurator_surcharge_solar | default: 10000 }},
       surcharge_cassette: {{ settings.configurator_surcharge_cassette | default: 5000 }}
    }
  };
</script>
